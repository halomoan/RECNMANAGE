/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["fin/re/conmgmts1/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","fin/re/conmgmts1/model/formatter","fin/re/conmgmts1/util/SelectDataBindingHelper","sap/m/MessageBox","jquery.sap.global"],function(B,J,H,f,S,M,$){"use strict";var i=false;var a=false;var j=false;return B.extend("fin.re.conmgmts1.controller.Contract",{formatter:f,systemId:null,webGUIUrl:null,onInit:function(){this._bMessageOpen=false;var o=this.getView().getBusyIndicatorDelay();var v=new J({busy:true,delay:0});this.setModel(v,"view");this.setModel(new J({events:[]}),"timeline");this.setModel(new J({currentTimeline:[]}),"currentTimeline");this.setModel(new J({}),"timelineRange");this._showOverDueRiminder=false;this.getRouter().getRoute("contract").attachPatternMatched(this._onRouteMatched,this);this.getRouter().getRoute("systemContract").attachPatternMatched(this._onRouteMatched,this);this.getOwnerComponent().getModel().metadataLoaded().then(function(){v.setProperty("/delay",o);});this._reminderPopover=null;},onExit:function(){if(this._reminderPopover){this._reminderPopover.destroy();}},onNavBack:function(){var h=H.getInstance();var p=h.getPreviousHash();if(p===undefined){this.getRouter().navTo("worklist",{},true);}else{history.go(-1);}},onAfterRendering:function(){this._initObjectBlock();this._initConditionBlock();this._bindTermsSection();var c=new sap.ui.model.Filter("Current",sap.ui.model.FilterOperator.EQ,"true");this._initRenewalTable(c);this._initBreakOptionTable(c);this._bindPartnerSection();this._initDocumentSection();this._initJumpOffWebGUIButton();if(sap.ui.Device.browser.name==="ff"){this._initTable4FF();}this.getModel().setDefaultBindingMode("TwoWay");},_initRenewalTable:function(b){var t=this.getView().byId("renewalBlock");var r=sap.ui.getCore().byId(t.getSelectedView()+"--"+"renewalList");var s=sap.ui.getCore().byId(t.getSelectedView()+"--"+"renewalFilter");s.attachSelect(this._onListSegmentedButtonSelect(r));r.attachBeforeRebindTable(this._renderingTableBySegmentedButton(s,b));},_initTable4FF:function(){var t=this.getView().byId("renewalBlock");var b=this.getView().byId("breakOptionBlock");var r=sap.ui.getCore().byId(t.getSelectedView()+"--"+"renewalList");var c=sap.ui.getCore().byId(b.getSelectedView()+"--"+"breakOptionList");r.rebindTable();c.rebindTable();},_initBreakOptionTable:function(b){var c=this.getView().byId("breakOptionBlock");var d=sap.ui.getCore().byId(c.getSelectedView()+"--"+"breakOptionList");var s=sap.ui.getCore().byId(c.getSelectedView()+"--"+"breakOptionFilter");s.attachSelect(this._onListSegmentedButtonSelect(d));d.attachBeforeRebindTable(this._renderingTableBySegmentedButton(s,b));},_initJumpOffWebGUIButton:function(){var v=this.getView();var m=v.getModel();m.attachRequestCompleted(function(){if(!a){var b=m.getMetaModel();if(b.getODataEntitySet("ContractTransactionDataSet")){j=true;}a=true;}});},_onListSegmentedButtonSelect:function(l){return function(e){l.rebindTable();};},_bindPartnerSection:function(){var v=this.getView();var m=v.byId("mainPartnerBlock");m.bindElement("MainPartner");},_renderingTableBySegmentedButton:function(s,b){return function(e){var m=e.getParameter("bindingParams");if(s.getSelectedKey()===""||s.getSelectedKey()==="next"){m.filters.push(b);}};},_initDocumentSection:function(){var v=this.getView();var m=v.getModel();var t=this;m.attachRequestCompleted(function(){if(!i){var b=m.getMetaModel();var e=b.getODataEntitySet("ContractDocumentDataSet");if(e.hasOwnProperty("sap:addressable")&&e["sap:addressable"]==="false"){v.byId("documentSection").setVisible(false);}else{var d=v.byId("documentListBlock");var c=sap.ui.getCore().byId(d.getSelectedView()+"--"+"documentListItem");var o=sap.ui.getCore().byId(d.getSelectedView()+"--"+"openUploadDialogButton");c.attachPress(t._onDocumentPress.bind(t));o.attachPress(t._onOpenUploadFileDialog.bind(t));}i=true;}});},_onDocumentPress:function(I){var s=this.getModel().sServiceUrl;var r=this.getView().getBindingContext().getPath();var d=I.getSource().getBindingContext().getPath().replace("ContractDocumentDataSet","Documents");var u;if(I.getSource().getBindingContext().getProperty("Documenttype")==='URL'){var D=r+d;this.getModel().read(D,{success:function(o){u=o.Url;sap.m.URLHelper.redirect(u,true);}});}else{u=s+r+d+"/$value";window.open(u,'_blank');}I.stopPropagation();},_onOpenUploadFileDialog:function(e){if(!this.uploadFileDialog){this.uploadFileDialog=sap.ui.xmlfragment('fin.re.conmgmts1.view.documentblocks.dialog.UploadDocumentDialog',this);this.getView().addDependent(this.uploadFileDialog);}this.uploadFileDialog.open();},closeUploadFileDialog:function(e){this.uploadFileDialog.close();},handleUploadPress:function(e){var t=this;this.getModel().refreshSecurityToken();var c=this.getModel().oHeaders['x-csrf-token'];var s=this.getModel().sServiceUrl;var r=this.getView().getBindingContext().sPath;var u=s+r+"/Documents";var F=sap.ui.getCore().byId('fileUploader');var b=F.getValue();var d=$.sap.domById(F.getId()+"-fu").files[0];var h={"x-csrf-token":c,"Slug":b};$.ajax({type:'POST',url:u,headers:h,cache:false,contentType:"application/json",dataType:"json",processData:false,data:d,success:function(g){var k=t.getView().byId("documentListBlock");var l=sap.ui.getCore().byId(k.getSelectedView()+"--"+"documentList");l.rebindTable();t.uploadFileDialog.close();},error:function(g){t._showServiceError(g);}});},onRenameContractPress:function(e){this.editContractDialog=sap.ui.xmlfragment('fin.re.conmgmts1.view.contractstermblocks.dialog.EditContractDialog',this);this.getView().addDependent(this.editContractDialog);this.editContractDialog.open();},renameContract:function(e){this.getView().getModel().submitChanges();this.editContractDialog.close();this.editContractDialog.destroy();},closeRenameContractDialog:function(e){this.editContractDialog.close();this.editContractDialog.destroy();},_showServiceError:function(d){var e=this.getResourceBundle().getText("Error.Text");if(this._bMessageOpen){return;}this._bMessageOpen=true;M.error(e,{id:"serviceErrorMessageBox",details:d,styleClass:this.getOwnerComponent().getContentDensityClass(),actions:[M.Action.CLOSE],onClose:function(){this._bMessageOpen=false;}.bind(this)});},_initObjectBlock:function(){var o=this.getView().byId("objectListBlock");var b=sap.ui.getCore().byId(o.getSelectedView()+"--"+"objectList");var c=sap.ui.getCore().byId(o.getSelectedView()+"--"+"objectSlice");S.initBlockWithTimeSlice(b,c,"Objects","ObjectSlice");},_initConditionBlock:function(){var c=this.getView().byId("conditionListBlock");var b=sap.ui.getCore().byId(c.getSelectedView()+"--"+"conditionList");var d=sap.ui.getCore().byId(c.getSelectedView()+"--"+"conditionSlice");S.initBlockWithTimeSlice(b,d,"Conditions","ConditionSlice");},_onRouteMatched:function(e){var n=e.getParameter("name");var b=e.getParameter("arguments");this.getModel().metadataLoaded().then(function(){var k=this._getKeyObjectFromRouting(n,b);var p="/"+this.getModel().createKey("ContractDataSet",k);this._bindView(p);}.bind(this));this.setModel(new J({busy:true}),"timelineview");this.getModel("timeline").setData({events:[]});},_getKeyObjectFromRouting:function(n,b){var k={Bukrs:decodeURIComponent(b.companyCode),Recnnr:decodeURIComponent(b.contractId)};if(n==="systemContract"){k["SAP__Origin"]=b.systemId;this.systemId=b.systemId;}else{this.systemId=null;}return k;},_bindView:function(p){var d=this.getModel();var v=this.getModel("view");var t=this;this.getView().bindElement({path:p,events:{change:this._onBindingChange.bind(this),dataRequested:function(){d.metadataLoaded().then(function(){v.setProperty("/busy",true);});},dataReceived:function(){t._initTimeline();v.setProperty("/busy",false);var b=t.getView().byId("breakOptionBlock");var c=sap.ui.getCore().byId(b.getSelectedView()+"--"+"breakOptionList-btnPersonalisation");c.setType("Transparent");var r=t.getView().byId("renewalBlock");var e=sap.ui.getCore().byId(r.getSelectedView()+"--"+"renewalList-btnPersonalisation");e.setType("Transparent");var o=t.getView().byId("objectListBlock");var g=sap.ui.getCore().byId(o.getSelectedView()+"--"+"objectList-btnPersonalisation");g.setType("Transparent");var h=t.getView().byId("conditionListBlock");var k=sap.ui.getCore().byId(h.getSelectedView()+"--"+"conditionList-btnPersonalisation");k.setType("Transparent");var l=t.getView().byId("valuationListBlock");var m=sap.ui.getCore().byId(l.getSelectedView()+"--"+"valuationList-btnPersonalisation");m.setType("Transparent");var n=t.getView().byId("documentListBlock");var q=sap.ui.getCore().byId(n.getSelectedView()+"--"+"documentList-btnPersonalisation");q.setType("Transparent");}}});t._initTimeline();},_initTimeline:function(){var t=this;function b(y){var n=new Date();return new Date(n.getFullYear()+y,n.getMonth(),n.getDate());}t.getModel().read(t.getView().getBindingContext().getPath()+'/Timeline',{filters:[new sap.ui.model.Filter({path:"Eventtype",operator:sap.ui.model.FilterOperator.EQ,value1:'C'})],success:function(r){var c=t.getOwnerComponent().getModel('i18n').getResourceBundle();var d=r.results[0];var e=d.Eventtype;d={typeText:c.getText('Terms.Timeline.Event.Type.'+e),dateFrom:d.Datefrom,dateTo:d.Dateto,eventInfo:d.Info,notifDateTo:d.Notifdateto,type:e};t.getModel("currentTimeline").setData({currentTimeline:d});var g=t.getView().byId("timelineBlock");sap.ui.getCore().byId(g.getSelectedView()+"--"+"timeline").onAfterRendering();}});t.getModel().read(t.getView().getBindingContext().getPath()+'/Timeline',{filters:[new sap.ui.model.Filter([new sap.ui.model.Filter({path:"Datefrom",operator:sap.ui.model.FilterOperator.GE,value1:b(-1)}),new sap.ui.model.Filter({path:"Datefrom",operator:sap.ui.model.FilterOperator.LE,value1:b(5)})],true)],success:function(r){var c=t.getOwnerComponent().getModel('i18n').getResourceBundle();var e=r.results.map(function(g){var h=g.Eventtype;return{typeText:c.getText('Terms.Timeline.Event.Type.'+h),dateFrom:g.Datefrom,dateTo:g.Dateto,eventInfo:g.Info,notifDateTo:g.Notifdateto,type:h};});t.getModel("timeline").setData({events:e});t.getModel("timelineRange").setData({from:b(-1),to:b(5)});t.getModel("timelineview").setProperty("/busy",false);var d=t.getView().byId("timelineBlock");sap.ui.getCore().byId(d.getSelectedView()+"--"+"timeline").onAfterRendering();t.getModel("timeline").setData({events:e});}});},_createBindingPath:function(e,k,v){return e+"("+k+"='"+v+"')";},_bindTermsSection:function(){var v=this.getModel("view");var V=this.getView();V.byId("termBlock").bindElement({path:"Term",events:{dataRequested:function(){v.setProperty("/busy",true);},dataReceived:function(){v.setProperty("/busy",false);}}});},_onBindingChange:function(){var v=this.getView();var b=this.getModel("view");var e=v.getElementBinding();if(!e.getBoundContext()){this.getRouter().getTargets().display("contractNotFound");return;}this._updateWebGUIUrl(false);b.setProperty("/busy",false);},_updateWebGUIUrl:function(o){this.webGUIUrl=null;if(j){var t=this;var p=this.getView().getBindingContext().getPath()+'/Transaction(';if(this.systemId){p+='SAP__Origin=\''+this.systemId+'\',';}p+='Tcode=\'RECN\')';this.getModel().read(p,{success:function(r){if(r&&r.Url&&r.Ttext){t.webGUIUrl=r.Url;var b=t.getView().byId("jumpOffWebGUI");b.setEnabled(true);b.setText(r.Ttext);if(o){window.open(r.Url,"_blank");}}}});}},onReminderPopoverButtonPressed:function(e){if(!this._reminderPopover){this._reminderPopover=sap.ui.xmlfragment('fin.re.conmgmts1.view.reminderblocks.ReminderPopover',this);this.getView().addDependent(this._reminderPopover);}this._reminderPopover.setPlacement(sap.m.PlacementType.Bottom);this._reminderPopover.openBy(e.getSource());},onReminderPopoverClose:function(){if(this._reminderPopover){this._reminderPopover.close();}},onJumpOffWebGUIPressed:function(e){if(this.webGUIUrl){window.open(this.webGUIUrl,"_blank");}else{this._updateWebGUIUrl(true);}},onPartnerFilterSelection:function(e){var b=e.getSource().getParent().getParent().getBlocks();var k=e.getSource().getSelectedKey();var s=k==="all";b[1].setVisible(!s);b[2].setVisible(s);},onTimelineFilterSelection:function(e){var k=e.getSource().getSelectedKey();var s=k==="all";var t=this.getView().byId("timelineBlock");var b=sap.ui.getCore().byId(t.getSelectedView()+"--"+"timeline");b.setNext(!s);b.onAfterRendering();}});});

/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/thirdparty/d3',"sap/ui/core/ResizeHandler","sap/ui/model/json/JSONModel"],function($,C,c,R,J){'use strict';return C.extend('fin.re.conmgmts1.controls.timeline.TimeLine',{metadata:{properties:{from:{type:'object',bindable:true},to:{type:'object',bindable:true},currentTimeline:{type:'object',bindable:true},next:{type:'boolean',bindable:true}},aggregations:{items:{type:'fin.re.conmgmts1.controls.timeline.TimeLineItem',multiple:true,singularName:'item',bindable:true}},defaultAggregation:'items',events:{press:{enableEventBubbling:true}}},_sResizeHandlerId:null,init:function(){},renderer:function(r,o){r.write("<div");r.writeControlData(o);r.addClass('timeline-chart-container');r.writeClasses();r.write('>');r.write("</div>");},openPopOver:function(s,e){if(!this._reminderPopover){this._reminderPopover=sap.ui.xmlfragment('fin.re.conmgmts1.view.contractstermblocks.TimelinePopover',this);this.addDependent(this._reminderPopover);}this._reminderPopover.setModel(new J({date:e.dateTo,info:e.eventInfo}),'selectedTimelineEvent');this._reminderPopover.openBy(s);},_mapEventsColor:function(a,t){var b='#000';switch(t){case'L':b='#fac364';break;case'M':b='#d998cb';break;case'V':b='#5cbae6';break;case'W':b='#b6d957';break;case'R':b='#5cbae6';break;case'K':b='#d998cb';break;default:b='#000';}a.map(function(e){if(e.eventType==='R'&&e.dateFrom.getTime()<new Date().getTime()){e.color="#888888";}else{e.color=b;}});return a;},_mapEventsIcon:function(e,t){var i='\ue220';switch(t){case'L':i='\ue22a';break;case'M':i='\ue22a';break;case'V':i='\ue053';break;case'W':i='\ue0a7';break;case'R':i='\ue030';break;case'K':i='\ue22a';break;default:i='\ue220';}e.map(function(d){d.icon=i;});return e;},_getDaysDiff:function(e,a){var d=parseInt(e.dateTo.getTime()/86400000,0);var b=parseInt(a.dateFrom.getTime()/86400000,0);return d-b;},_addHeightByCount:function(e,h){var r=h;if(e===1){r=r+35;}else if(e===0){r=r;}else{r=r+(e-1)*15+35;}return r;},_getLengthDiff:function(e,a){var l=parseInt((e.dateTo.getTime()-e.dateFrom.getTime())/86400000,0);var b=parseInt((a.dateTo.getTime()-a.dateFrom.getTime())/86400000,0);return l-b;},_setY:function(e,s){var a=0;var b=0;var d;if(e.length>0){d=e[0];a=a+1;e[0].y=s;b=1;}var y=s;for(var i=1;i<e.length;i++){var f=this._getDaysDiff(d,e[i]);if(f<-45){y=s;d=e[i];if(b>a){a=b;}b=1;}else{y=y+15;b=b+1;if(this._getLengthDiff(d,e[i])<-5){d=e[i];}}e[i].y=y;}if(b>a){a=b;}return{count:a,events:e};},_getSortedEventsByType:function(e,t){var f=e.filter(function(d){return d.eventType===t;});var s=f.sort(function(a,b){if(t==='W'||t==='V'){return b.dateFrom.getTime()-a.dateFrom.getTime();}else{return a.dateFrom.getTime()-b.dateFrom.getTime();}});s=this._mapEventsColor(s,t);s=this._mapEventsIcon(s,t);if(t==='V'||t==='W'){s=f.filter(function(d){var a=parseInt(d.dateFrom.getTime()/86400000,0);var b=parseInt(new Date().getTime()/86400000,0);return a>=b;});}if(this.getNext()&&s.length>0&&t!='R'){s=(t==='V'||t==='W')?[s[s.length-1]]:[s[0]];}return s;},_breakDateText:function(d,s){return d.split(s);},_drawReminders:function(s,e,x,y){var t=this;var r=s.append("g");r.selectAll(".reminder").data(e).enter().append("text").attr("class","reminder").attr("x",function(d){return x(d.dateFrom);}).attr("y",y).on("click",function(d){t.openPopOver(this,d);}).style("display","none").attr("dy",".35em").attr("dx","-.80em").style("font-family","SAP-icons").style("fill",function(d){return d.color;}).text(function(d){return d.icon;});},_drawEvent:function(s,e,x,w){var l=s.append("g");l.selectAll(".itemline").data(e).enter().append("line").attr("class","itemline").attr("y1",function(d){return d.y;}).attr("y2",function(d){return d.y;}).attr("x1",function(d){if(x(d.dateFrom)<0){return 0;}else if(x(d.dateFrom)>(w-264)){return(w-264);}else{return x(d.dateFrom);}}).attr("x2",function(d){return x(d.dateTo)>(w-264)?(w-264):x(d.dateTo);}).style("fill","none").style("stroke",function(d){return d.color;}).style("stroke-width","3").style("shape-rendering","crispEdges");l.selectAll(".enddot").data(e).enter().append("line").attr("class","enddot").attr("y1",function(d){return d.y-5;}).attr("y2",function(d){return d.y+5;}).attr("x1",function(d){return x(d.dateTo);}).attr("x2",function(d){return x(d.dateTo);}).style("display",function(d){return x(d.dateTo)>(w-264)?"none":"";}).style("stroke-width","3").style("shape-rendering","crispEdges").style("stroke",function(d){return d.color;});if((e.length>0)&&(e[0].eventType==="V"||e[0].eventType==="W")){l.selectAll(".dotline").data(e).enter().append("line").attr("class","dotline").attr("y1",function(d){return d.y;}).attr("y2",function(d){return d.y;}).attr("x1",function(d){return x(d.notifDateTo);}).attr("x2",function(d){return x(d.dateFrom);}).style("stroke-dasharray","3,5").style("stroke-width","3").style("shape-rendering","crispEdges").style("stroke",function(d){return d.color;});}l.selectAll(".starticon").data(e).enter().append("text").attr("class","starticon").attr("x",function(d){return d.notifDateTo===undefined?x(d.dateFrom):x(d.notifDateTo);}).attr("y",function(d){return d.y;}).attr("dy",".35em").attr("dx","-.80em").style("font-family","SAP-icons").style("fill",function(d){return d.color;}).text(function(d){return d.icon;});},resize:function(){var b=this.getModel("i18n").getResourceBundle();var t=b.getText("Terms.Timeline.Label.Today");var s=b.getText("Terms.Timeline.Label.ShowReminders");var a=this;var e=c.time.format.multi([["%b",function(d){return d.getMonth();}],["%b:%Y",function(){return true;}]]);var w=parseInt(c.select(".timeline-chart-container").style("width"),10);var f=w>800?3:12;var h=parseInt(c.select(".timeline-chart-container").style("height"),10);var g=this.getItems();var m=[];for(var i=0;i<g.length;i++){m.push({"dateFrom":g[i].getProperty("dateFrom"),"dateTo":g[i].getProperty("dateTo"),"eventType":g[i].getProperty("eventType"),"eventLevel":g[i].getProperty("eventLevel"),"eventInfo":g[i].getProperty("eventInfo"),"notifDateTo":g[i].getProperty("notifDateTo")});}var j=this.getCurrentTimeline();h=75;if(!(j instanceof Array)){var k=this._setY(this._getSortedEventsByType(m,"V"),h);var o=k.events;h=this._addHeightByCount(k.count,h);k=this._setY(this._getSortedEventsByType(m,"W"),h);var l=k.events;h=this._addHeightByCount(k.count,h);k=this._setY(this._getSortedEventsByType(m,"L"),h);var n=k.events;h=this._addHeightByCount(k.count,h);k=this._setY(this._getSortedEventsByType(m,"M"),h);var p=k.events;h=this._addHeightByCount(k.count,h);k=this._setY(this._getSortedEventsByType(m,"K"),h);var q=k.events;h=this._addHeightByCount(k.count,h);var r=this._getSortedEventsByType(m,"R",-0.3);var u=this.getFrom();var v=this.getTo();var y=this.getId();var x=c.time.scale().domain([u,v]).range([0,w-264]);var z=c.svg.axis().scale(x).orient("bottom").tickSize(6,0).tickFormat(e).ticks(c.time.months,f);var A=c.select("svg").remove();A=c.select("#"+y).append("svg").attr("width",w).attr("height",h).append("g").style("font","11px sans-serif");A.append("g").attr("transform","translate(0,"+40+")").attr("class","x axis").call(z);j.color='#000';var B=A.append("g");B.append("line").attr("y1",40).attr("y2",40).attr("x1",function(){return x(j.dateFrom);}).attr("x2",function(){return x(j.dateTo)>(w-264)?(w-264):x(j.dateTo);}).style("fill","none").style("stroke","#000").style("stroke","#000").style("stroke-width","3").style("shape-rendering","crispEdges");B.append("circle").attr("cx",function(){return x(j.dateFrom);}).attr("cy",40).attr("r",4).style("fill","#000");if(x(j.dateTo)<=(w-264)){B.append("line").attr("y1",35).attr("y2",45).attr("x1",x(j.dateTo)).attr("x2",x(j.dateTo)).style("stroke-width","3").style("stroke","#000");}var D=[];if(j){D.push(j);}if(o.length>0){D.push(o[0]);}if(l.length>0){D.push(l[0]);}if(n.length>0){D.push(n[0]);}if(p.length>0){D.push(p[0]);}if(q.length>0){D.push(q[0]);}var E=A.selectAll(".legend").data(D).enter().append("g").attr("class","legend").attr("transform",function(d,i){return"translate(0,"+(i+2)*18+")";});E.append("line").attr("y1",6).attr("y2",6).attr("x1",w-214).attr("x2",w-190).style("stroke",function(d){return d.color;}).style("stroke-width","3");E.append("text").attr("x",w-184).attr("y",6).attr("dy",".35em").style("text-anchor","start").text(function(d){return d.eventInfo;});this._drawEvent(A,o,x,w);this._drawEvent(A,l,x,w);this._drawEvent(A,n,x,w);this._drawEvent(A,p,x,w);this._drawEvent(A,q,x,w);this._drawReminders(A,r,x,55);A.append("g").append("line").attr("y1",15).attr("y2",h).attr("x1",x(new Date())).attr("x2",x(new Date())).style("stroke","#000").style("stroke-width","1").style("stroke-dasharray","5");A.append("text").attr("x",x(new Date())).attr("y",1).attr("dy",".70em").attr("dx","1.1em").style("text-anchor","end").text(t);c.selectAll("g.tick line").each(function(d){c.select(this).attr("y1",h).attr("y2","-5");});c.selectAll("g.tick text").each(function(d){var F=a._breakDateText(c.select(this).text(),":");c.select(this).text('');c.select(this).append('tspan').attr('y','0').attr('dy','-0.5em').text(F[0]);c.select(this).append('tspan').attr('y','0').attr('dx','-1.5em').attr('dy','1.2em').text(F[1]);});A.append("foreignObject").attr("width",200).attr("height",200).attr("x",w-214).attr("y",0).append("xhtml:body").html("<form><input type=checkbox id=check>"+s+"</input></form>").on("click",function(d,i){if(A.select("#check").node().checked){A.selectAll(".reminder").style("display","");}else{A.selectAll(".reminder").style("display","none");}});}},onAfterRendering:function(){this.resize();this._sResizeHandlerId=R.register(this,$.proxy(this.resize,this));}});},true);
